# 이게뭐약 도커 컴포즈 yml
#   - 메인 서버 / DL 서버 (각 레포지터리 내 docker file)
#   - DB 서버 / HAProxy (컴포즈 파일 내 작성)
# 구조
#   - HAProxy - 메인 서버 - HAProxy - DL 서버
#   - 메인 서버는 LB 없이 DB와 연결
version: "3.8"

services:
  # 메인서버
  main:
    build: ../wip_main
    container_name: wip_main
      
    environment:
      - TZ=Asia/Seoul
      - DL_SERVER_URL=http://localhost:${DL_PORT_NUMBER}/data

    # 컨테이너 내부에서 사용할 .env
    env_file:
      - ../wip_main/.env

    depends_on:
      - db

    ports:
      - ${MAIN_SERVER_PORT}:${MAIN_SERVER_PORT}

    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: continue
  
  # 딥러닝 서버
  dl:
    build: ../wip_dl
    container_name: wip_dl

    environment:
      - TZ=Asia/Seoul
    
    # 컨테이너 내부에서 사용할 .env
    env_file:
      - ../wip_dl/deeplearning_server/.env

    depends_on:
      - main
      - db

    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: continue

  # DBMS
  db:
    image: mongo:5.0.5
    container_name: wip_mongo

    environment:
      - TZ=Asia/Seoul
      - MONGO_INIT_DB_DATABASE=whatispill

    volumes:
      - ../data:/data/db

    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: continue